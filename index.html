<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í–‰ë™ ì‘¥ì‘¥ ì¹´ìš´í„°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #F1F5F9; /* Slate-100 */
            touch-action: manipulation;
            overscroll-behavior: none;
        }
        .btn-press-effect:active {
            transform: scale(0.98);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        /* Token Animation */
        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            70% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        .token-animate {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* Icon Grid */
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
        }
        
        @media (max-width: 640px) {
            .icon-grid { grid-template-columns: repeat(4, 1fr); gap: 0.25rem; }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800 bg-slate-100">

    <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4 z-20 shrink-0">
        <div class="max-w-5xl mx-auto flex justify-between items-center w-full">
            <h1 class="text-xl md:text-2xl font-black text-emerald-600 flex items-center gap-2 cursor-pointer select-none" onclick="location.reload()">
                <span>ğŸŒ±</span> í–‰ë™ ì‘¥ì‘¥
            </h1>
            <div class="flex items-center gap-3">
                <div id="save-status" class="text-[10px] font-bold text-emerald-600 hidden items-center bg-emerald-50 border border-emerald-100 px-2 py-1 rounded-full shadow-sm">
                    <span>ğŸ’¾ ì €ì¥ë¨</span>
                </div>
                <button onclick="clearAllDataPrompt()" class="text-xs text-gray-400 hover:text-red-400 underline hidden md:block">ì „ì²´ ì´ˆê¸°í™”</button>
            </div>
        </div>
    </header>

    <main class="flex-1 overflow-hidden relative w-full max-w-5xl mx-auto md:p-6">
        
        <section id="view-home" class="p-4 h-full flex flex-col justify-center items-center animate-fade-in overflow-y-auto">
            <div class="bg-white p-8 md:p-10 rounded-3xl shadow-xl border border-gray-100 w-full max-w-lg transition-all">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        <span>ğŸ§‘â€ğŸ“</span> í•™ìƒ ì„ íƒ/ê´€ë¦¬
                    </h2>
                    <span class="text-xs font-bold text-gray-500 bg-gray-50 px-3 py-1 rounded-full">Step 0</span>
                </div>
                
                <div id="student-list-container" class="space-y-3 max-h-80 overflow-y-auto mb-6">
                    </div>
                
                <button id="start-all-tracking-btn" onclick="startAllStudentTracking()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold text-lg py-4 rounded-2xl shadow-lg shadow-emerald-200 transition transform btn-press-effect flex justify-center items-center gap-2 mb-4 hidden">
                    <span>ğŸš€ ì¼ê´„ ê´€ì°° ì‹œì‘í•˜ê¸°</span>
                </button>
                <button onclick="editStudentConfig()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold text-lg py-4 rounded-2xl shadow-lg shadow-indigo-200 transition transform btn-press-effect flex justify-center items-center gap-2">
                    <span>â• ìƒˆë¡œìš´ í•™ìƒ ë“±ë¡í•˜ê¸°</span>
                    <span class="text-2xl">âœ¨</span>
                </button>
            </div>
        </section>


        <section id="view-setup" class="p-4 h-full hidden flex-col justify-center items-center animate-fade-in overflow-y-auto">
            <div class="bg-white p-8 md:p-10 rounded-3xl shadow-xl border border-gray-100 w-full max-w-lg transition-all">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        <span>âœï¸</span> ê´€ì°° ì„¤ì • (<span id="setup-student-name">í•™ìƒëª…</span>)
                    </h2>
                    <span class="text-xs font-bold text-indigo-500 bg-indigo-50 px-3 py-1 rounded-full">Step 1</span>
                </div>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-500 mb-2 uppercase tracking-wide">í•™ìƒ ì´ë¦„</label>
                        <input type="text" id="student-name" placeholder="ì˜ˆ: ê¹€ì‚¬ë‘" onchange="saveConfig()" class="w-full h-14 px-4 bg-gray-50 border-2 border-gray-100 rounded-2xl focus:bg-white focus:border-emerald-400 focus:ring-4 focus:ring-emerald-100 outline-none transition text-lg font-bold text-gray-700 placeholder-gray-300">
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-500 mb-2 uppercase tracking-wide">ê´€ì°° ëª©í‘œ í–‰ë™</label>
                        <div class="space-y-3" id="behavior-inputs">
                            <div class="flex gap-3 items-center group" id="behavior-row-1">
                                <button onclick="openIconPicker(1)" id="icon-btn-1" class="w-14 h-14 flex-shrink-0 bg-white rounded-2xl text-3xl flex items-center justify-center border-2 border-gray-200 group-hover:border-emerald-400 group-hover:bg-emerald-50 transition shadow-sm active:scale-95">ğŸ‘€</button>
                                <input type="hidden" id="icon-val-1" value="ğŸ‘€">
                                <input type="text" id="behavior-1" value="ëˆˆ ë§ì¶¤ í•˜ê¸°" onchange="saveConfig()" class="flex-1 h-14 px-4 border-2 border-gray-100 rounded-2xl focus:border-emerald-400 focus:ring-4 focus:ring-emerald-100 outline-none font-bold text-gray-700 transition" placeholder="í–‰ë™ 1">
                                <button onclick="removeBehaviorInput(1)" class="w-10 h-10 flex-shrink-0 rounded-full bg-red-50 hover:bg-red-100 text-red-500 transition text-sm font-bold">X</button>
                            </div>
                            <div class="flex gap-3 items-center group" id="behavior-row-2">
                                <button onclick="openIconPicker(2)" id="icon-btn-2" class="w-14 h-14 flex-shrink-0 bg-white rounded-2xl text-3xl flex items-center justify-center border-2 border-gray-200 group-hover:border-emerald-400 group-hover:bg-emerald-50 transition shadow-sm active:scale-95">ğŸ‘‚</button>
                                <input type="hidden" id="icon-val-2" value="ğŸ‘‚">
                                <input type="text" id="behavior-2" value="ë°”ë¥¸ ìì„¸ ìœ ì§€" onchange="saveConfig()" class="flex-1 h-14 px-4 border-2 border-gray-100 rounded-2xl focus:border-emerald-400 focus:ring-4 focus:ring-emerald-100 outline-none font-bold text-gray-700 transition" placeholder="í–‰ë™ 2">
                                <button onclick="removeBehaviorInput(2)" class="w-10 h-10 flex-shrink-0 rounded-full bg-red-50 hover:bg-red-100 text-red-500 transition text-sm font-bold">X</button>
                            </div>
                            <div class="flex gap-3 items-center group" id="behavior-row-3">
                                <button onclick="openIconPicker(3)" id="icon-btn-3" class="w-14 h-14 flex-shrink-0 bg-white rounded-2xl text-3xl flex items-center justify-center border-2 border-gray-200 group-hover:border-emerald-400 group-hover:bg-emerald-50 transition shadow-sm active:scale-95">âœ¨</button>
                                <input type="hidden" id="icon-val-3" value="âœ¨">
                                <input type="text" id="behavior-3" value="" onchange="saveConfig()" class="flex-1 h-14 px-4 border-2 border-gray-100 rounded-2xl focus:border-emerald-400 focus:ring-4 focus:ring-emerald-100 outline-none font-bold text-gray-700 transition" placeholder="í–‰ë™ 3 (ì„ íƒ)">
                                <button onclick="removeBehaviorInput(3)" class="w-10 h-10 flex-shrink-0 rounded-full bg-red-50 hover:bg-red-100 text-red-500 transition text-sm font-bold">X</button>
                            </div>
                        </div>
                    </div>
                </div>

                <button onclick="startSession()" class="w-full mt-10 bg-emerald-500 hover:bg-emerald-600 text-white font-bold text-xl py-4 rounded-2xl shadow-xl shadow-emerald-200 transition transform btn-press-effect flex justify-center items-center gap-2">
                    <span>ê´€ì°° ì‹œì‘í•˜ê¸°</span>
                    <span class="text-2xl">ğŸš€</span>
                </button>

                <button onclick="switchView('home')" class="w-full mt-4 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl hover:bg-gray-200 transition">
                    ì €ì¥ ë° í•™ìƒ ê´€ë¦¬ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
            </div>
        </section>

        <section id="view-tracking" class="hidden h-full flex-col md:flex-row p-4 md:p-0 gap-6">
            
            <div class="flex-1 flex flex-col h-full min-h-0">
                <div class="bg-white rounded-2xl px-6 py-4 shadow-sm border border-gray-100 flex justify-between items-center shrink-0 mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-xl">â±ï¸</div>
                        <div>
                            <span class="text-xs font-bold text-gray-400 block leading-none mb-1">ì´ ê´€ì°° ì‹œê°„</span>
                            <span class="text-2xl font-mono font-bold text-emerald-600 tabular-nums leading-none" id="timer-display">00:00</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-xs font-bold text-gray-400 block leading-none mb-1">ê´€ì°° ì¤‘ì¸ í•™ìƒ</span>
                        <span class="text-xl font-bold text-gray-800 leading-none" id="tracking-student-count">0ëª…</span>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto no-scrollbar pb-2">
                    <div id="buttons-container" class="grid gap-4 h-full md:h-auto content-start">
                        </div>
                </div>
            </div>

            <div class="h-48 md:h-full md:w-80 shrink-0 bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col overflow-hidden">
                <div class="px-4 py-3 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                    <h3 class="font-bold text-gray-600 text-sm flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> í†µí•© ê¸°ë¡
                    </h3>
                    <div class="flex gap-2">
                         <button onclick="undoLastLog()" class="px-3 py-1.5 bg-white border border-gray-200 rounded-lg text-xs font-bold text-red-500 hover:bg-red-50 transition shadow-sm">
                            â†© ì·¨ì†Œ
                        </button>
                        <button onclick="stopAllTrackingAndGoHome()" class="px-3 py-1.5 bg-slate-800 text-white rounded-lg text-xs font-bold hover:bg-slate-700 transition shadow-sm">
                            ì „ì²´ ì¢…ë£Œ
                        </button>
                    </div>
                </div>
                <ul id="log-list" class="flex-1 overflow-y-auto p-2 space-y-2 bg-gray-50/50"></ul>
            </div>
        </section>

        <section id="view-report" class="hidden h-full flex-col overflow-y-auto no-scrollbar p-4 md:p-0">
            <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100 mb-6 w-full">
                <div class="flex flex-col md:flex-row justify-between items-end mb-8 border-b border-gray-100 pb-6 gap-6">
                    <div>
                        <h2 class="text-3xl font-black text-gray-800 mb-2">ğŸ“Š ê´€ì°° ë¦¬í¬íŠ¸</h2>
                        <div class="flex gap-4 text-sm text-gray-500 font-medium">
                            <span id="report-date">2023. 00. 00</span>
                            <span class="text-gray-300">|</span>
                            <span>ì´ ì‹œê°„: <span id="report-duration" class="text-emerald-600 font-bold">00:00</span></span>
                        </div>
                    </div>
                    <div class="flex gap-3 w-full md:w-auto">
                        <button onclick="goToHome()" class="flex-1 md:flex-none px-6 py-3 bg-emerald-500 text-white rounded-xl font-bold hover:bg-emerald-600 shadow-lg shadow-emerald-200 transition">ìƒˆë¡œìš´ ê´€ì°°</button>
                        <button onclick="window.print()" class="flex-1 md:flex-none px-6 py-3 bg-white text-gray-600 border border-gray-200 rounded-xl font-bold hover:bg-gray-50 transition">ì¸ì‡„</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100 h-80 relative">
                        <canvas id="resultChart"></canvas>
                    </div>
                    <div class="overflow-hidden rounded-2xl border border-gray-100">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="bg-gray-100 text-gray-500 uppercase text-xs font-bold">
                                <tr>
                                    <th class="px-6 py-4">í–‰ë™</th>
                                    <th class="px-6 py-4 text-right">ë¹ˆë„</th>
                                    <th class="px-6 py-4 text-right">ë¹„ìœ¨</th>
                                </tr>
                            </thead>
                            <tbody id="report-table-body" class="bg-white divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <div id="icon-picker-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-end sm:items-center justify-center animate-fade-in backdrop-blur-sm">
            <div class="bg-white w-full max-w-xl h-[70vh] sm:h-auto sm:max-h-[80vh] rounded-t-3xl sm:rounded-3xl shadow-2xl flex flex-col overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                    <h3 class="text-xl font-black text-gray-800">ì•„ì´ì½˜ ì„ íƒ</h3>
                    <button onclick="closeIconPicker()" class="w-8 h-8 rounded-full bg-white hover:bg-gray-200 flex items-center justify-center text-gray-500 font-bold shadow-sm">&times;</button>
                </div>
                
                <div class="flex-1 overflow-y-auto p-6 bg-white custom-scroll">
                    <div class="space-y-6">
                        <div>
                            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">ğŸ« í•™êµ ìƒí™œ</h4>
                            <div class="icon-grid">
                                <button onclick="selectIcon('ğŸ‘€')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-indigo-100 transition">ğŸ‘€</button>
                                <button onclick="selectIcon('ğŸ‘‚')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-indigo-100 transition">ğŸ‘‚</button>
                                <button onclick="selectIcon('ğŸª‘')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-indigo-100 transition">ğŸª‘</button>
                                <button onclick="selectIcon('âœ‹')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-indigo-100 transition">âœ‹</button>
                                <button onclick="selectIcon('âœï¸')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-indigo-100 transition">âœï¸</button>
                                <button onclick="selectIcon('ğŸ’')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-indigo-100 transition">ğŸ’</button>
                                <button onclick="selectIcon('ğŸ“’')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-indigo-100 transition">ğŸ“’</button>
                                <button onclick="selectIcon('ğŸ«')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-indigo-100 transition">ğŸ«</button>
                                <button onclick="selectIcon('ğŸ±')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-indigo-100 transition">ğŸ±</button>
                                <button onclick="selectIcon('ğŸš½')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-indigo-100 transition">ğŸš½</button>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">ğŸƒ í–‰ë™ / í™œë™</h4>
                            <div class="icon-grid">
                                <button onclick="selectIcon('ğŸš¶')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-amber-100 transition">ğŸš¶</button>
                                <button onclick="selectIcon('ğŸƒ')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-amber-100 transition">ğŸƒ</button>
                                <button onclick="selectIcon('ğŸ—£ï¸')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-amber-100 transition">ğŸ—£ï¸</button>
                                <button onclick="selectIcon('ğŸ¤«')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-amber-100 transition">ğŸ¤«</button>
                                <button onclick="selectIcon('ğŸ¤')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-amber-100 transition">ğŸ¤</button>
                                <button onclick="selectIcon('ğŸ™…')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-amber-100 transition">ğŸ™…</button>
                                <button onclick="selectIcon('ğŸ™†')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-amber-100 transition">ğŸ™†</button>
                                <button onclick="selectIcon('ğŸ¨')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-amber-100 transition">ğŸ¨</button>
                                <button onclick="selectIcon('ğŸ§©')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-amber-100 transition">ğŸ§©</button>
                                <button onclick="selectIcon('ğŸ§¸')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-amber-100 transition">ğŸ§¸</button>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">â¤ï¸ ë³´ìƒ / ê°ì •</h4>
                            <div class="icon-grid">
                                <button onclick="selectIcon('âœ¨')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-pink-100 transition">âœ¨</button>
                                <button onclick="selectIcon('â­')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-pink-100 transition">â­</button>
                                <button onclick="selectIcon('â¤ï¸')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-pink-100 transition">â¤ï¸</button>
                                <button onclick="selectIcon('ğŸ‘')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-pink-100 transition">ğŸ‘</button>
                                <button onclick="selectIcon('ğŸ˜€')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-pink-100 transition">ğŸ˜€</button>
                                <button onclick="selectIcon('ğŸ˜¢')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-pink-100 transition">ğŸ˜¢</button>
                                <button onclick="selectIcon('ğŸ˜¡')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-pink-100 transition">ğŸ˜¡</button>
                                <button onclick="selectIcon('ğŸ’Š')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-pink-100 transition">ğŸ’Š</button>
                                <button onclick="selectIcon('ğŸ’¤')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-pink-100 transition">ğŸ’¤</button>
                                <button onclick="selectIcon('â“')" class="text-3xl p-3 bg-gray-50 rounded-xl hover:bg-pink-100 transition">â“</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- Core State Structure ---
        // State holds configuration/report data for the student currently loaded into SETUP/REPORT view
        let state = {
            currentStudentId: null, 
            studentName: '',
            behaviors: [],
            startTime: null, 
            endTime: null,
            timerInterval: null, 
            logs: [], 
            counts: {}, 
            isTracking: false 
        };
        // All students data stored in local storage and managed here
        let allStudents = {}; 
        let globalTimerInterval = null; 

        const colors = [
            { bg: 'bg-indigo-50', text: 'text-indigo-700', border: 'border-indigo-100', sticker: 'â­', hover: 'hover:border-indigo-300' },
            { bg: 'bg-pink-50', text: 'text-pink-700', border: 'border-pink-100', sticker: 'ğŸŒ¸', hover: 'hover:border-pink-300' },
            { bg: 'bg-amber-50', text: 'text-amber-700', border: 'border-amber-100', sticker: 'ğŸ£', hover: 'hover:border-amber-300' }
        ];

        // --- Persistence Keys & DOM Elements ---
        const STORAGE_KEY_STUDENTS = 'behaviorApp_all_students_v8'; // Updated version key
        const DEFAULT_STUDENT_ID = 'new-default-student';

        const els = {
            views: {
                home: document.getElementById('view-home'),
                setup: document.getElementById('view-setup'),
                tracking: document.getElementById('view-tracking'),
                report: document.getElementById('view-report')
            },
            timerDisplay: document.getElementById('timer-display'),
            logList: document.getElementById('log-list'),
            saveStatus: document.getElementById('save-status'),
            iconPickerModal: document.getElementById('icon-picker-modal'),
            setupStudentName: document.getElementById('setup-student-name'),
            studentListContainer: document.getElementById('student-list-container'),
            trackingStudentCount: document.getElementById('tracking-student-count'),
            startAllTrackingBtn: document.getElementById('start-all-tracking-btn') // ì¶”ê°€
        };

        let currentPickingId = null; 

        // --- Persistence & Core Student Management ---

        function loadAllStudents() {
            const saved = localStorage.getItem(STORAGE_KEY_STUDENTS);
            if (saved) {
                try {
                    allStudents = JSON.parse(saved);
                } catch(e) {
                    console.error("í•™ìƒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", e);
                    allStudents = {};
                }
            } else {
                allStudents = {};
            }
        }

        function saveAllStudents() {
            localStorage.setItem(STORAGE_KEY_STUDENTS, JSON.stringify(allStudents));
        }

        function clearAllDataPrompt() {
            if(confirm('ê²½ê³ : ëª¨ë“  í•™ìƒ ë°ì´í„°ì™€ ì„¤ì •ì„ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem(STORAGE_KEY_STUDENTS);
                location.reload();
            }
        }

        function saveStudentData(id, name, config, session) {
            allStudents[id] = {
                id,
                name,
                config,
                session: session || allStudents[id]?.session || { isTracking: false }
            };
            saveAllStudents();
        }
        
        function deleteStudent(id) {
            if (confirm(`${allStudents[id].name} í•™ìƒì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                delete allStudents[id];
                saveAllStudents();
                if (getActiveStudentIds().length > 0) {
                    renderActiveTracking();
                    updateLogDisplay();
                }
                renderHomeView();
            }
        }

        function saveConfig() {
            const studentId = state.currentStudentId || 'student-' + Date.now();
            const studentName = document.getElementById('student-name').value || 'í•™ìƒëª…';

            const config = {
                b1: document.getElementById('behavior-1').value,
                icon1: document.getElementById('icon-val-1').value,
                b2: document.getElementById('behavior-2').value,
                icon2: document.getElementById('icon-val-2').value,
                b3: document.getElementById('behavior-3').value,
                icon3: document.getElementById('icon-val-3').value,
            };
            
            const sessionData = allStudents[studentId]?.session || { isTracking: false };

            saveStudentData(studentId, studentName, config, sessionData);

            state.currentStudentId = studentId;
            state.studentName = studentName;
            els.setupStudentName.textContent = studentName;
        }

        function loadConfig(id, data = null) {
            const studentData = data || allStudents[id] || {};
            const config = studentData.config || {};
            
            // Set Inputs
            document.getElementById('student-name').value = studentData.name || '';
            
            // Handle behavior inputs dynamically to respect deletion
            for(let i=1; i<=3; i++) {
                document.getElementById(`behavior-${i}`).value = config[`b${i}`] || '';
                // ê¸°ë³¸ê°’ ì„¤ì • (ì•„ì´ì½˜ ê°’ì´ ì—†ì„ ê²½ìš°)
                document.getElementById(`icon-val-${i}`).value = config[`icon${i}`] || (i === 1 ? 'ğŸ‘€' : (i === 2 ? 'ğŸ‘‚' : 'âœ¨')); 
                document.getElementById(`icon-btn-${i}`).textContent = document.getElementById(`icon-val-${i}`).value;
                // [FIX] X ë²„íŠ¼ì„ ëˆ„ë¥¸ í›„ ë¹„ì–´ ìˆëŠ” í–‰ì€ ê°ì¶”ì§€ ì•ŠìŠµë‹ˆë‹¤. ëŒ€ì‹  saveConfigì—ì„œ ë¹ˆ ê°’ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.
            }

            // Set global state for the current context
            state.currentStudentId = id;
            state.studentName = studentData.name || 'í•™ìƒëª…';
            els.setupStudentName.textContent = state.studentName;
        }
        
        // [FIXED] Function to remove a behavior input row - ë¹ˆ ê°’ìœ¼ë¡œ ë§Œë“¤ê³  ì €ì¥í•˜ì—¬ ì‹¤ì œ ë°ì´í„°ì—ì„œ ì œê±°ë˜ë„ë¡ ìˆ˜ì •
        function removeBehaviorInput(id) {
            // Check how many non-empty behavior inputs exist
            const behaviorCount = [1, 2, 3].filter(i => document.getElementById(`behavior-${i}`).value.trim() !== '').length;
            
            // If only one is left, and the user is trying to clear that one, prevent it.
            if (behaviorCount <= 1 && document.getElementById(`behavior-${id}`).value.trim() !== '') {
                alert('ìµœì†Œ 1ê°œì˜ ê´€ì°° ëª©í‘œ í–‰ë™ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            // Clear the specific inputs and reset icon/value
            document.getElementById(`behavior-${id}`).value = '';
            // ì•„ì´ì½˜ ê°’ë„ ê¸°ë³¸ê°’(ì„ì‹œê°’)ì´ë‚˜ ë¹ˆ ê°’ìœ¼ë¡œ ì„¤ì • (í˜„ì¬ ì…‹ì—… í™”ë©´ì˜ ì…ë ¥ ë°©ì‹ ìœ ì§€)
            document.getElementById(`icon-val-${id}`).value = (id === 1 ? 'ğŸ‘€' : (id === 2 ? 'ğŸ‘‚' : 'âœ¨')); 
            document.getElementById(`icon-btn-${id}`).textContent = document.getElementById(`icon-val-${id}`).value;
            
            saveConfig(); // ë³€ê²½ëœ ì„¤ì • ì €ì¥ (ë¹ˆ í–‰ë™ì€ ì €ì¥ë˜ì§€ ì•ŠìŒ)
        }


        // --- View Navigation & Home View ---

        function switchView(viewName) {
            Object.values(els.views).forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('flex');
            });
            const target = els.views[viewName];
            target.classList.remove('hidden');
            target.classList.add('flex');
            
            if (viewName === 'home') {
                renderHomeView();
                if (globalTimerInterval) clearInterval(globalTimerInterval);
            } else if (viewName === 'tracking') {
                renderActiveTracking();
                updateLogDisplay();
                startGlobalTimer();
            } else {
                if (globalTimerInterval) clearInterval(globalTimerInterval);
            }
        }

        function renderHomeView() {
            els.studentListContainer.innerHTML = '';
            const studentIds = Object.keys(allStudents);
            const activeIds = getActiveStudentIds(); // ê´€ì°° ì¤‘ì¸ í•™ìƒ ìˆ˜ í™•ì¸

            if (studentIds.length === 0) {
                els.studentListContainer.innerHTML = '<p class="text-center text-gray-400 py-10">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</p>';
                els.startAllTrackingBtn.classList.add('hidden');
                return;
            }
            
            // ë“±ë¡ëœ í•™ìƒì´ ìˆê³ , ê´€ì°° ì¤‘ì¸ í•™ìƒì´ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì¼ê´„ ê´€ì°° ì‹œì‘ ë²„íŠ¼ í‘œì‹œ
            if (studentIds.length > 0 && activeIds.length === 0) {
                els.startAllTrackingBtn.classList.remove('hidden');
            } else {
                els.startAllTrackingBtn.classList.add('hidden');
            }


            studentIds.forEach(id => {
                const data = allStudents[id];
                const isTracking = data.session?.isTracking;

                const card = document.createElement('div');
                card.className = `
                    flex items-center justify-between p-4 rounded-xl border-2 shadow-sm transition-all
                    ${isTracking ? 'bg-emerald-50 border-emerald-400 ring-2 ring-emerald-100' : 'bg-white border-gray-100 hover:border-indigo-300'}
                `;

                let statusText = isTracking ? 
                    `<span class="text-emerald-600 font-bold flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> ê´€ì°° ì¤‘</span>` : 
                    `<span class="text-gray-400">ì„¤ì • ì™„ë£Œ</span>`;

                card.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">ğŸ§‘â€ğŸ“</span>
                        <div>
                            <span class="text-lg font-bold text-gray-800">${data.name}</span>
                            <div class="text-xs text-gray-500">${statusText}</div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="handleStudentAction('${id}', ${isTracking})" 
                                class="px-4 py-2 bg-indigo-500 text-white rounded-lg text-sm font-bold hover:bg-indigo-600 transition shadow-md">
                            ${isTracking ? 'ê´€ì°° ì¬ê°œ/ë³´ê¸°' : 'ì„¤ì •/ì‹œì‘'}
                        </button>
                        <button onclick="deleteStudent('${id}')" 
                                class="w-8 h-8 rounded-full bg-gray-100 hover:bg-red-50 text-red-400 transition text-sm">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                `;
                els.studentListContainer.appendChild(card);
            });
        }
        
        // [NEW] ëª¨ë“  í•™ìƒì˜ ê´€ì°°ì„ ì¼ê´„ ì‹œì‘í•˜ëŠ” í•¨ìˆ˜
        function startAllStudentTracking() {
            const studentIds = Object.keys(allStudents);
            let hasValidBehavior = false;

            // ëª¨ë“  í•™ìƒì— ëŒ€í•´ startSession ì‹¤í–‰
            studentIds.forEach(id => {
                const studentData = allStudents[id];
                if (!studentData.session.isTracking) {
                    
                    const behaviors = [];
                    for (let i = 1; i <= 3; i++) {
                        const bName = studentData.config[`b${i}`];
                        if (bName && bName.trim() !== '') {
                             behaviors.push({
                                id: `b${i}`,
                                name: bName,
                                icon: studentData.config[`icon${i}`],
                                color: colors[i - 1]
                            });
                        }
                    }

                    if (behaviors.length > 0) {
                        const counts = {};
                        behaviors.forEach(b => counts[b.id] = 0);
                        
                        studentData.session = {
                            isTracking: true,
                            startTime: Date.now(),
                            logs: [],
                            counts,
                            behaviors 
                        };
                        hasValidBehavior = true;
                    }
                }
            });

            if (hasValidBehavior) {
                saveAllStudents();
                switchView('tracking');
            } else {
                alert('ê´€ì°°ì„ ì‹œì‘í•  ìœ íš¨í•œ í–‰ë™ ì„¤ì •ì´ ìˆëŠ” í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤. í•™ìƒ ì„¤ì • í™”ë©´ì—ì„œ ìµœì†Œ 1ê°œì˜ í–‰ë™ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.');
            }
        }
        // [/NEW]

        function handleStudentAction(id, isTracking) {
            const data = allStudents[id];
            
            if (isTracking) {
                renderActiveTracking();
                switchView('tracking');
            } else {
                editStudentConfig(id, data);
            }
        }

        function editStudentConfig(id = null, data = null) {
            const newId = id || 'student-' + Date.now();
            loadConfig(newId, data);
            switchView('setup');
        }

        // --- Global Tracking Management ---
        function getActiveStudentIds() {
            return Object.keys(allStudents).filter(id => allStudents[id].session?.isTracking);
        }

        function startGlobalTimer() {
            if (globalTimerInterval) clearInterval(globalTimerInterval);
            updateGlobalTimerDisplay();
            globalTimerInterval = setInterval(updateGlobalTimerDisplay, 1000);
        }

        function updateGlobalTimerDisplay() {
            const activeIds = getActiveStudentIds();
            els.trackingStudentCount.textContent = `${activeIds.length}ëª…`;

            if (activeIds.length === 0) {
                if (globalTimerInterval) clearInterval(globalTimerInterval);
                els.timerDisplay.textContent = '00:00';
                return;
            }
            
            let earliestStart = Infinity;
            activeIds.forEach(id => {
                if (allStudents[id].session.startTime < earliestStart) {
                    earliestStart = allStudents[id].session.startTime;
                }
            });

            const now = Date.now();
            const diff = Math.floor((now - earliestStart) / 1000);
            if (diff < 0 || earliestStart === Infinity) { els.timerDisplay.textContent = "00:00"; return; }
            const mm = String(Math.floor(diff / 60)).padStart(2, '0');
            const ss = String(diff % 60).padStart(2, '0');
            els.timerDisplay.textContent = `${mm}:${ss}`;
        }

        // --- Core Session Logic ---

        function startSession() {
            saveConfig();
            
            const studentId = state.currentStudentId;
            const studentData = allStudents[studentId];
            
            const config = studentData.config;
            const behaviors = [];
            for (let i = 1; i <= 3; i++) {
                const bName = config[`b${i}`];
                if (bName && bName.trim() !== '') {
                    behaviors.push({
                        id: `b${i}`,
                        name: bName,
                        icon: config[`icon${i}`],
                        color: colors[i - 1]
                    });
                }
            }

            if (behaviors.length === 0) {
                alert('ìµœì†Œ 1ê°œì˜ í–‰ë™ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const counts = {};
            behaviors.forEach(b => counts[b.id] = 0);
            
            studentData.session = {
                isTracking: true,
                startTime: Date.now(),
                logs: [],
                counts,
                behaviors 
            };

            saveAllStudents();
            switchView('tracking');
        }

        function recordBehavior(studentId, behavior) {
            const student = allStudents[studentId];
            const session = student.session;
            session.counts[behavior.id] = (session.counts[behavior.id] || 0) + 1;
            
            const count = session.counts[behavior.id];
            
            const numEl = document.getElementById(`num-count-${studentId}-${behavior.id}`);
            if(numEl) numEl.textContent = count;

            const board = document.getElementById(`sticker-board-${studentId}-${behavior.id}`);
            if(board) {
                if(count === 1) board.innerHTML = ''; 
                
                const maxVisuals = 15;
                if (count <= maxVisuals) {
                    const span = document.createElement('span');
                    span.className = `token-animate text-xl leading-none ${(count > 1 && (count-1) % 5 === 0) ? 'ml-1' : ''}`;
                    span.textContent = 'â­';
                    board.appendChild(span);
                } else {
                    const affectedContainer = document.getElementById(`student-buttons-${studentId}`);
                    if(affectedContainer) renderBehaviorButtons(studentId, affectedContainer);
                }
            }

            const now = Date.now();
            const diff = Math.floor((now - session.startTime) / 1000);
            const mm = String(Math.floor(diff / 60)).padStart(2, '0');
            const ss = String(diff % 60).padStart(2, '0');

            session.logs.push({
                studentId,
                studentName: student.name,
                behaviorId: behavior.id,
                behaviorName: behavior.name,
                behaviorIcon: behavior.icon,
                timestamp: now,
                timeString: `${mm}:${ss}`,
                colorClass: behavior.color.text
            });

            updateLogDisplay();
            saveAllStudents();
            
            els.saveStatus.classList.remove('hidden');
            els.saveStatus.classList.add('flex');
            setTimeout(() => {
                els.saveStatus.classList.add('hidden');
                els.saveStatus.classList.remove('flex');
            }, 1500);
        }

        function renderActiveTracking() {
            const activeIds = getActiveStudentIds();
            const container = document.getElementById('buttons-container');
            container.innerHTML = '';
            
            if (activeIds.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 py-20">ê´€ì°° ì¤‘ì¸ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤. í•™ìƒ ê´€ë¦¬ í™”ë©´ì—ì„œ ê´€ì°°ì„ ì‹œì‘í•˜ì„¸ìš”.</p>';
                return;
            }

            const numActive = activeIds.length;
            let gridClass = 'grid-cols-1 md:grid-cols-2 lg:grid-cols-2'; 
            if (numActive > 4) {
                gridClass = 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3';
            }
            
            container.className = `grid ${gridClass} gap-4 h-full md:h-auto content-start`;


            activeIds.forEach(id => {
                const studentData = allStudents[id];
                
                const panel = document.createElement('div');
                panel.className = `
                    bg-white rounded-3xl p-4 shadow-xl border-4 border-gray-100 
                    flex flex-col min-h-[300px] overflow-hidden
                `;
                
                panel.innerHTML = `
                    <div class="flex items-center justify-between mb-3 border-b pb-2">
                        <span class="text-xl font-black text-gray-800 flex items-center gap-2">
                            <span class="text-2xl">ğŸ§‘â€ğŸ“</span> ${studentData.name}
                        </span>
                        <button onclick="finalizeReportAndShowReport('${id}')" class="px-3 py-1 bg-red-500 text-white rounded-lg text-xs font-bold hover:bg-red-600 transition shadow-sm">
                            ê°œë³„ ì¢…ë£Œ
                        </button>
                    </div>
                    <div id="student-buttons-${id}" class="flex-1 grid gap-2">
                    </div>
                `;
                container.appendChild(panel);
                
                const btnContainer = document.getElementById(`student-buttons-${id}`);
                renderBehaviorButtons(id, btnContainer);
            });
        }

        function renderBehaviorButtons(studentId, container) {
            const session = allStudents[studentId].session;
            const behaviors = session.behaviors || [];
            
            const numBehaviors = behaviors.length;
            let buttonGridClass = 'grid-cols-1';
            if (numBehaviors === 2 || numBehaviors === 3) {
                buttonGridClass = 'grid-cols-2';
            }

            container.className = `grid ${buttonGridClass} gap-3`;
            container.innerHTML = ''; 

            behaviors.forEach(b => {
                const count = session.counts[b.id] || 0;
                
                let visualTokensHtml = '';
                const maxVisuals = 15; 
                const displayCount = Math.min(count, maxVisuals);
                
                for(let i=0; i<displayCount; i++) {
                    const extraMargin = (i > 0 && i % 5 === 0) ? 'ml-1' : '';
                    visualTokensHtml += `<span class="token-animate text-xl leading-none ${extraMargin}">â­</span>`;
                }

                if (count > maxVisuals) {
                    visualTokensHtml += `<span class="text-sm font-bold bg-white/50 px-1 rounded ml-1">+${count - maxVisuals}</span>`;
                }

                const btn = document.createElement('div');
                btn.className = `
                    relative w-full min-h-[150px] rounded-2xl border-2 transition-all duration-100 
                    flex flex-col p-3 cursor-pointer select-none btn-press-effect active:scale-[0.98] shadow-md hover:shadow-lg
                    ${b.color.bg} ${b.color.border} ${b.color.hover}
                `;
                
                btn.onclick = () => recordBehavior(studentId, b);

                btn.innerHTML = `
                    <div class="flex justify-between items-start mb-2 pointer-events-none">
                        <div class="flex items-center gap-2">
                            <span class="text-4xl filter drop-shadow-sm">${b.icon}</span>
                            <span class="text-lg font-black ${b.color.text} leading-tight">${b.name}</span>
                        </div>
                        <div class="bg-white/80 backdrop-blur-sm px-3 py-1 rounded-xl shadow-sm border border-white/50">
                            <span id="num-count-${studentId}-${b.id}" class="text-3xl font-black ${b.color.text} tabular-nums">${count}</span>
                        </div>
                    </div>
                    
                    <div id="sticker-board-${studentId}-${b.id}" class="flex-1 bg-white/40 rounded-xl p-2 flex flex-wrap content-start items-start gap-0.5 pointer-events-none shadow-inner min-h-[80px]">
                        ${count === 0 ? '<span class="text-gray-400/50 text-xs font-bold w-full text-center mt-6">í„°ì¹˜í•˜ì—¬ ìŠ¤í‹°ì»¤ ë¶™ì´ê¸°</span>' : visualTokensHtml}
                    </div>
                    
                    <div class="absolute inset-0 bg-white opacity-0 hover:opacity-10 active:opacity-20 transition-opacity rounded-2xl pointer-events-none"></div>
                `;
                container.appendChild(btn);
            });
        }

        function updateLogDisplay() {
            els.logList.innerHTML = '';
            
            let allLogs = [];
            getActiveStudentIds().forEach(id => {
                allLogs = allLogs.concat(allStudents[id].session.logs);
            });
            
            allLogs.sort((a, b) => b.timestamp - a.timestamp);

            allLogs.slice(0, 50).forEach(log => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center bg-white p-3 rounded-xl border border-gray-100 shadow-sm animate-fade-in mb-2";
                li.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-2xl bg-gray-50 p-1.5 rounded-lg border border-gray-100">${log.behaviorIcon}</span>
                        <div class="flex flex-col">
                            <span class="font-bold text-gray-700 text-sm">${log.behaviorName}</span>
                            <span class="text-xs text-gray-400 font-medium">${log.studentName}</span> 
                        </div>
                    </div>
                    <span class="text-xs font-mono font-bold text-gray-400 bg-gray-50 px-2 py-1 rounded border border-gray-100">${log.timeString}</span>
                `;
                els.logList.appendChild(li);
            });
            
            if (allLogs.length === 0) {
                els.logList.innerHTML = '<li class="text-center text-gray-400 py-10 text-sm font-medium">ê¸°ë¡ ì—†ìŒ</li>';
            }
        }

        function undoLastLog() {
            let allLogs = [];
            getActiveStudentIds().forEach(id => {
                allLogs = allLogs.concat(allStudents[id].session.logs);
            });
            
            if (allLogs.length === 0) return;
            
            allLogs.sort((a, b) => b.timestamp - a.timestamp);
            const lastLog = allLogs[0];
            
            const session = allStudents[lastLog.studentId].session;

            const logIndex = session.logs.findIndex(log => log.timestamp === lastLog.timestamp);
            if (logIndex !== -1) {
                session.logs.splice(logIndex, 1);
            }
            
            if (session.counts[lastLog.behaviorId] > 0) {
                session.counts[lastLog.behaviorId]--;
            }
            
            const affectedContainer = document.getElementById(`student-buttons-${lastLog.studentId}`);
            if (affectedContainer) {
                renderBehaviorButtons(lastLog.studentId, affectedContainer);
            }

            updateLogDisplay();
            saveAllStudents();
        }

        function finalizeReport(studentId) {
            const session = allStudents[studentId].session;
            session.endTime = Date.now();
            session.isTracking = false;
            saveAllStudents();
        }
        
        function finalizeReportAndShowReport(studentId) {
            if (!confirm(`${allStudents[studentId].name} í•™ìƒì˜ ê´€ì°°ì„ ì¢…ë£Œí•˜ê³  ê²°ê³¼ë¥¼ ë³´ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            finalizeReport(studentId);
            
            if (getActiveStudentIds().length === 0) {
                renderReport(studentId);
                switchView('report');
            } else {
                renderActiveTracking(); 
                updateLogDisplay();
            }
        }

        function stopAllTrackingAndGoHome() {
            if (!confirm('í˜„ì¬ ê´€ì°° ì¤‘ì¸ ëª¨ë“  í•™ìƒì˜ ì„¸ì…˜ì„ ì¢…ë£Œí•˜ê³  í•™ìƒ ê´€ë¦¬ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const activeIds = getActiveStudentIds();
            
            activeIds.forEach(id => finalizeReport(id));
            
            if (activeIds.length > 0) {
                // ë§ˆì§€ë§‰ìœ¼ë¡œ ì¢…ë£Œëœ í•™ìƒì˜ ë¦¬í¬íŠ¸ë¥¼ í‘œì‹œ
                renderReport(activeIds[activeIds.length - 1]); 
                switchView('report');
            } else {
                switchView('home');
            }
        }

        function renderReport(studentId) {
            const studentData = allStudents[studentId];
            const session = studentData.session;
            
            document.getElementById('report-date').textContent = new Date(session.endTime).toLocaleDateString();
            
            const diff = Math.floor((session.endTime - session.startTime) / 1000);
            const mm = String(Math.floor(diff / 60)).padStart(2, '0');
            const ss = String(diff % 60).padStart(2, '0');
            document.getElementById('report-duration').textContent = `${mm}:${ss}`;
            
            const tbody = document.getElementById('report-table-body');
            tbody.innerHTML = '';
            
            const totalCounts = Object.values(session.counts).reduce((a, b) => a + b, 0);

            session.behaviors.forEach(b => {
                const count = session.counts[b.id] || 0;
                const percentage = totalCounts > 0 ? Math.round((count / totalCounts) * 100) : 0;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 font-bold text-gray-700 flex items-center gap-3">
                        <span class="text-2xl">${b.icon}</span> ${b.name}
                    </td>
                    <td class="px-6 py-4 text-right font-black text-emerald-600 text-xl">
                        ${count} <span class="text-xs font-normal text-gray-400 ml-0.5">stars</span>
                    </td>
                    <td class="px-6 py-4 text-right font-medium text-gray-500">${percentage}%</td>
                `;
                tbody.appendChild(tr);
            });

            const chartContainer = document.querySelector('#view-report .bg-gray-50.rounded-2xl.p-4');
            chartContainer.innerHTML = '<canvas id="resultChart"></canvas>';
            
            new Chart(document.getElementById('resultChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: session.behaviors.map(b => b.name),
                    datasets: [{
                        label: 'íšë“í•œ ìŠ¤í‹°ì»¤',
                        data: session.behaviors.map(b => session.counts[b.id] || 0),
                        backgroundColor: ['rgba(79, 70, 229, 0.7)', 'rgba(236, 72, 153, 0.7)', 'rgba(245, 158, 11, 0.7)'],
                        borderRadius: 8,
                        barThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

        function goToHome() {
            switchView('home');
        }

        // --- Icon Picker Logic (Helper) ---

        function openIconPicker(id) {
            currentPickingId = id;
            els.iconPickerModal.classList.remove('hidden');
            els.iconPickerModal.classList.add('flex');
        }

        function closeIconPicker() {
            els.iconPickerModal.classList.add('hidden');
            els.iconPickerModal.classList.remove('flex');
            currentPickingId = null;
        }

        function selectIcon(icon) {
            if (currentPickingId) {
                document.getElementById(`icon-btn-${currentPickingId}`).textContent = icon;
                document.getElementById(`icon-val-${currentPickingId}`).value = icon;
                saveConfig();
            }
            closeIconPicker();
        }

        // --- Init ---
        window.addEventListener('DOMContentLoaded', () => {
            loadAllStudents();
            switchView('home'); 
        });

    </script>
</body>
</html>
